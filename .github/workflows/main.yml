name: Calcpad Automation Workflow

on:
  push:
    paths:
      - 'cpdinput/**.cpd'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup .NET 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install Calcpad CLI via Dotnet Tool
        run: |
          dotnet tool install --global Calcpad.Cli --version 7.5.9
          export PATH="$PATH:$HOME/.dotnet/tools"
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Verify Installation
        run: |
          export PATH="$PATH:$HOME/.dotnet/tools"
          which calcpad || echo "Calcpad not in PATH"
          calcpad --version || calcpad -h || echo "Calcpad verification failed but continuing..."

      - name: Process CPD Files
        run: |
          export PATH="$PATH:$HOME/.dotnet/tools"
          mkdir -p cpdoutput
          
          for file in cpdinput/*.cpd; do
            [ -e "$file" ] || continue
            filename=$(basename "$file" .cpd)
            echo "üîÑ Processing: $filename"
            
            calcpad "$file" || echo "‚ö†Ô∏è Warning: Failed to process $filename"
            
            if [ -f "cpdinput/$filename.html" ]; then
              mv "cpdinput/$filename.html" "cpdoutput/$filename.html"
              echo "‚úÖ Generated: cpdoutput/$filename.html"
            else
              echo "‚ùå HTML not generated for $filename"
            fi
          done

      - name: Update Navigation Index
        run: |
          python3 scripts/update_index.py

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add cpdoutput/*.html calcpad.html
          git commit -m "Auto-generate reports [skip ci]" || echo "No changes"
          git push