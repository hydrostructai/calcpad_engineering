name: Calcpad Automation Workflow

on:
  push:
    paths:
      - 'cpdinput/**.cpd'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Calcpad and Dependencies
        run: |
          echo "üîß Installing dependencies for Calcpad..."
          
          # Update package lists
          sudo apt-get update -qq
          
          # Method 1: Try installing calcpad from Ubuntu repositories
          echo "üì¶ Attempting to install calcpad via apt..."
          if sudo apt-get install -y calcpad 2>/dev/null; then
            echo "‚úÖ calcpad installed via apt"
          else
            echo "‚ÑπÔ∏è  calcpad not in standard repos, trying calcpad-cli..."
            sudo apt-get install -y calcpad-cli 2>/dev/null || echo "‚ö†Ô∏è calcpad-cli also not available"
          fi
          
          # Method 2: Try alternative installation
          if ! command -v calcpad-run &> /dev/null; then
            echo "üì• Attempting snap installation..."
            sudo snap install calcpad --classic 2>/dev/null || echo "‚ö†Ô∏è Snap installation failed"
          fi
          
          # Install wkhtmltopdf for PDF generation
          echo "üì¶ Installing wkhtmltopdf..."
          sudo apt-get install -y wkhtmltopdf 2>/dev/null || echo "‚ö†Ô∏è wkhtmltopdf installation skipped"
          
          # Install Python3 and pip for index generation
          echo "üì¶ Installing Python3..."
          sudo apt-get install -y python3 python3-pip 2>/dev/null
          
          # Final verification
          echo ""
          echo "üîç VERIFICATION:"
          if command -v calcpad-run &> /dev/null; then
            echo "‚úÖ calcpad-run: $(which calcpad-run)"
            calcpad-run --version 2>/dev/null || echo "  (version check not available)"
          else
            echo "‚ö†Ô∏è  calcpad-run: NOT FOUND"
          fi
          
          if command -v wkhtmltopdf &> /dev/null; then
            echo "‚úÖ wkhtmltopdf: $(which wkhtmltopdf)"
          else
            echo "‚ö†Ô∏è  wkhtmltopdf: NOT FOUND"
          fi
          
          if command -v python3 &> /dev/null; then
            echo "‚úÖ python3: $(python3 --version)"
          else
            echo "‚ö†Ô∏è  python3: NOT FOUND"
          fi

      - name: Process CPD Files with Sync
        run: |
          set -x  # Enable debug output
          mkdir -p cpdoutput cpdpdf
          
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üîç GITHUB ACTIONS CPD-HTML-PDF SYNCHRONIZATION"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          # Pre-flight checks
          echo ""
          echo "üìÇ PRE-FLIGHT CHECKS:"
          echo "   Working directory: $(pwd)"
          echo "   cpdinput/ contents:"
          ls -lah cpdinput/ || echo "   (cpdinput/ does not exist!)"
          echo ""
          echo "   cpdoutput/ status:"
          ls -lah cpdoutput/ 2>/dev/null || echo "   (will be created)"
          echo ""
          echo "   cpdpdf/ status:"
          ls -lah cpdpdf/ 2>/dev/null || echo "   (will be created)"
          echo ""
          
          # =========================================================
          # STEP 1: DETECT AND DELETE ORPHANED FILES
          # =========================================================
          echo ""
          echo "üìã STEP 1: Detecting deleted .cpd files..."
          echo "‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï"
          
          DELETED_FILES=$(git show --name-status HEAD 2>/dev/null | grep "^D" | grep "\.cpd$" | awk '{print $2}' || echo "")
          
          if [ -z "$DELETED_FILES" ]; then
            echo "‚úÖ No deleted .cpd files"
          else
            echo "üóëÔ∏è  Found deleted files:"
            echo "$DELETED_FILES"
            
            # For each deleted .cpd, remove corresponding HTML and PDF
            while IFS= read -r deleted_path; do
              if [ -n "$deleted_path" ]; then
                filename=$(basename "$deleted_path" .cpd)
                html_file="cpdoutput/${filename}.html"
                pdf_file="cpdpdf/${filename}.pdf"
                
                if [ -f "$html_file" ]; then
                  rm -f "$html_file"
                  echo "  ‚úÖ Removed: $html_file"
                fi
                
                if [ -f "$pdf_file" ]; then
                  rm -f "$pdf_file"
                  echo "  ‚úÖ Removed: $pdf_file"
                fi
              fi
            done <<< "$DELETED_FILES"
          fi
          
          # =========================================================
          # STEP 2: PROCESS NEW AND MODIFIED CPD FILES
          # =========================================================
          echo ""
          echo "üìã STEP 2: Detecting new/modified .cpd files..."
          echo "‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï"
          
          CHANGED_FILES=$(git show --name-status HEAD 2>/dev/null | grep -E "^[AM]" | grep "\.cpd$" | awk '{print $2}' || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "‚úÖ No new/modified .cpd files"
          else
            echo "üÜï Found changed files:"
            echo "$CHANGED_FILES"
            
            # Process each changed .cpd file
            while IFS= read -r cpd_path; do
              if [ -n "$cpd_path" ] && [ -f "$cpd_path" ]; then
                filename=$(basename "$cpd_path" .cpd)
                echo ""
                echo "  üîÑ Processing: $filename"
                
                # Generate HTML via Calcpad
                if command -v calcpad-run &> /dev/null; then
                  echo "    ‚îú‚îÄ Generating HTML (calcpad-run)..."
                  echo "       Command: calcpad-run \"$cpd_path\""
                  
                  # Run with full error output for debugging
                  if calcpad-run "$cpd_path" 2>&1; then
                    echo "    ‚îú‚îÄ ‚úÖ calcpad-run execution successful"
                  else
                    echo "    ‚îú‚îÄ ‚ùå calcpad-run execution failed (exit code: $?)"
                  fi
                else
                  echo "    ‚îú‚îÄ ‚ùå calcpad-run COMMAND NOT FOUND"
                  echo "       Available commands:"
                  ls -la /usr/bin/*calcpad* 2>/dev/null || echo "       (No calcpad binaries found)"
                  
                  echo "       Attempting alternate method..."
                  RUNCPD=$(find /usr -name "runcpd" 2>/dev/null | head -1)
                  if [ -n "$RUNCPD" ]; then
                    echo "       Found runcpd at: $RUNCPD"
                    bash "$RUNCPD" "$cpd_path" 2>&1 || echo "       (runcpd also failed)"
                  fi
                fi
                
                # Check if HTML was actually created
                echo "    ‚îú‚îÄ Checking for generated HTML..."
                if [ -f "cpdinput/$filename.html" ]; then
                  echo "    ‚îú‚îÄ ‚úÖ Found: cpdinput/$filename.html ($(du -h cpdinput/$filename.html | cut -f1))"
                else
                  echo "    ‚îú‚îÄ ‚ùå NOT FOUND: cpdinput/$filename.html"
                  echo "       Contents of cpdinput/ directory:"
                  ls -lah cpdinput/ | grep "$filename"
                fi
                
                # Move HTML to output folder
                if [ -f "cpdinput/$filename.html" ]; then
                  mv "cpdinput/$filename.html" "cpdoutput/$filename.html"
                  echo "    ‚îú‚îÄ ‚úÖ HTML moved: cpdoutput/$filename.html"
                  
                  # Convert to PDF
                  if command -v wkhtmltopdf &> /dev/null; then
                    echo "    ‚îú‚îÄ Converting to PDF (wkhtmltopdf)..."
                    if wkhtmltopdf --quiet "cpdoutput/$filename.html" "cpdpdf/$filename.pdf" 2>/dev/null; then
                      echo "    ‚îî‚îÄ ‚úÖ PDF created: cpdpdf/$filename.pdf"
                    else
                      echo "    ‚îî‚îÄ ‚ö†Ô∏è  PDF conversion failed (continuing anyway)"
                    fi
                  else
                    echo "    ‚îî‚îÄ ‚ö†Ô∏è  wkhtmltopdf not available - HTML only"
                  fi
                else
                  echo "    ‚îî‚îÄ ‚ùå ERROR: HTML not generated for $filename"
                fi
              fi
            done <<< "$CHANGED_FILES"
          fi
          
          # =========================================================
          # STEP 3: REPORT FINAL STATE
          # =========================================================
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üìä FINAL STATE REPORT"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          echo ""
          echo "üìÇ Current CPD files in cpdinput/:"
          ls -1 cpdinput/*.cpd 2>/dev/null | wc -l
          ls -1 cpdinput/*.cpd 2>/dev/null || echo "  (none)"
          
          echo ""
          echo "üìÑ Generated HTML files in cpdoutput/:"
          HTML_COUNT=$(ls -1 cpdoutput/*.html 2>/dev/null | wc -l)
          echo "  Total: $HTML_COUNT files"
          ls -lh cpdoutput/*.html 2>/dev/null || echo "  (none)"
          
          echo ""
          echo "üìï Generated PDF files in cpdpdf/:"
          PDF_COUNT=$(ls -1 cpdpdf/*.pdf 2>/dev/null | wc -l)
          echo "  Total: $PDF_COUNT files"
          ls -lh cpdpdf/*.pdf 2>/dev/null || echo "  (none)"
          
          echo ""
          echo "‚ú® Synchronization complete!"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

      - name: Update Navigation Index
        run: |
          echo "üîÑ Updating index..."
          python3 scripts/update_index.py
          echo "‚úÖ Index updated"
          
          # Show what was generated
          echo ""
          echo "=== FINAL STATE ==="
          echo "HTML files in cpdoutput:"
          ls -1 cpdoutput/*.html 2>/dev/null | wc -l
          echo ""
          echo "calcpad.html content preview:"
          grep "report-count" calcpad.html || echo "No report-count found"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes to commit
          if git diff --quiet cpdoutput/ cpdpdf/ calcpad.html; then
            echo "‚úÖ No changes to commit (files already processed)"
          else
            echo "üìù Committing generated reports (HTML + PDF)..."
            git add cpdoutput/*.html cpdpdf/*.pdf calcpad.html 2>/dev/null || true
            git commit -m "Auto-generate reports: HTML + PDF [skip ci]"
            
            # Use GITHUB_TOKEN for authentication
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/hydrostructai/calcpad_engineering.git
            git push origin main
            echo "‚úÖ Pushed to GitHub"
          fi