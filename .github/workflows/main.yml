name: Calcpad Automation Workflow

on:
  push:
    paths:
      - 'cpdinput/**.cpd'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Calcpad and Dependencies
        run: |
          echo "üîß Installing Calcpad with multiple fallback methods..."
          
          # Update package lists
          sudo apt-get update -qq 2>/dev/null
          
          # Install essential build tools and libraries FIRST
          echo "üì¶ Installing system base packages..."
          sudo apt-get install -y \
            build-essential wget curl unzip git \
            python3 python3-pip \
            xvfb libxrender1 libxext6 \
            fontconfig fonts-dejavu \
            ca-certificates openssl \
            2>&1 | grep -E "^(Setting|Processing|Unpacking|done)" || true
          
          echo "‚úÖ Base packages installed"
          
          # ==========================================
          # METHOD 1: Add Calcpad PPA and install
          # ==========================================
          echo ""
          echo "üì¶ METHOD 1: Adding Calcpad PPA repository..."
          if sudo add-apt-repository -y ppa:agentim/calcpad 2>/dev/null; then
            sudo apt-get update -qq 2>/dev/null
            if sudo apt-get install -y calcpad 2>/dev/null; then
              echo "‚úÖ Calcpad installed from PPA"
            else
              echo "‚ö†Ô∏è  PPA installation failed"
            fi
          else
            echo "‚ö†Ô∏è  Could not add PPA"
          fi
          
          # ==========================================
          # METHOD 2: Install from Snap
          # ==========================================
          if ! command -v calcpad-run &> /dev/null; then
            echo ""
            echo "üì¶ METHOD 2: Trying snap installation..."
            if sudo snap install calcpad --classic 2>/dev/null; then
              echo "‚úÖ Calcpad installed from snap"
              export PATH=/snap/bin:$PATH
            else
              echo "‚ö†Ô∏è  Snap installation failed"
            fi
          fi
          
          # ==========================================
          # METHOD 3: Direct package download
          # ==========================================
          if ! command -v calcpad-run &> /dev/null; then
            echo ""
            echo "üì¶ METHOD 3: Downloading Calcpad directly..."
            TEMP_DIR=$(mktemp -d)
            cd "$TEMP_DIR"
            
            # Try downloading from Calcpad official sources
            if wget -q https://calcpad.eu/downloads/calcpad-ubuntu-latest.deb -O calcpad.deb 2>/dev/null || \
               wget -q https://github.com/Proectors/Calcpad/releases/download/v1.5.9/calcpad-1.5.9-linux.deb -O calcpad.deb 2>/dev/null; then
              echo "üì• Downloaded Calcpad package"
              sudo dpkg -i calcpad.deb 2>/dev/null || \
              sudo apt-get install -y -f 2>/dev/null
              echo "‚úÖ Calcpad installed from direct download"
            else
              echo "‚ö†Ô∏è  Direct download failed"
            fi
            cd - > /dev/null
            rm -rf "$TEMP_DIR"
          fi
          
          # ==========================================
          # METHOD 4: Try portable/standalone version
          # ==========================================
          if ! command -v calcpad-run &> /dev/null; then
            echo ""
            echo "üì¶ METHOD 4: Checking for local Calcpad..."
            if [ -f "/usr/bin/calcpad-run" ]; then
              echo "‚úÖ Found at /usr/bin/calcpad-run"
            elif [ -f "/usr/local/bin/calcpad-run" ]; then
              echo "‚úÖ Found at /usr/local/bin/calcpad-run"
              export PATH="/usr/local/bin:$PATH"
            elif command -v /snap/bin/calcpad-run &> /dev/null; then
              echo "‚úÖ Found snap version at /snap/bin/calcpad-run"
              export PATH="/snap/bin:$PATH"
            else
              echo "‚ö†Ô∏è  No Calcpad found in standard locations"
            fi
          fi
          
          # ==========================================
          # Install wkhtmltopdf
          # ==========================================
          echo ""
          echo "üì¶ Installing wkhtmltopdf..."
          if sudo apt-get install -y wkhtmltopdf 2>/dev/null; then
            echo "‚úÖ wkhtmltopdf installed"
          else
            echo "‚ö†Ô∏è  apt wkhtmltopdf failed, trying direct download..."
            TEMP_DIR=$(mktemp -d)
            cd "$TEMP_DIR"
            if wget -q https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltox_0.12.6-1.focal_amd64.deb 2>/dev/null; then
              sudo apt-get install -y -f ./wkhtmltox_0.12.6-1.focal_amd64.deb 2>/dev/null || true
              echo "‚úÖ wkhtmltopdf installed from direct download"
            fi
            cd - > /dev/null
            rm -rf "$TEMP_DIR"
          fi
          
          # ==========================================
          # FINAL VERIFICATION
          # ==========================================
          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîç INSTALLATION VERIFICATION:"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Check all possible locations
          CALCPAD_FOUND=0
          
          for PATH_DIR in /usr/bin /usr/local/bin /snap/bin ~/.local/bin; do
            if [ -x "$PATH_DIR/calcpad-run" ]; then
              echo "‚úÖ calcpad-run found at: $PATH_DIR/calcpad-run"
              "$PATH_DIR/calcpad-run" --version 2>/dev/null || echo "   (version info unavailable)"
              CALCPAD_FOUND=1
              # Add to PATH if not already there
              if [[ ":$PATH:" != *":$PATH_DIR:"* ]]; then
                export PATH="$PATH_DIR:$PATH"
              fi
              break
            fi
          done
          
          if [ $CALCPAD_FOUND -eq 0 ]; then
            echo "‚ùå CRITICAL: calcpad-run NOT FOUND in any standard location"
            echo "   Searching entire system..."
            sudo find / -name "calcpad-run" -type f 2>/dev/null | head -5 || echo "   (none found)"
            
            # As a fallback, try to find any calcpad binary
            echo ""
            echo "   Searching for any calcpad binary..."
            sudo find / -name "*calcpad*" -type f 2>/dev/null | grep -E "bin|exec" | head -5 || echo "   (none found)"
          fi
          
          if command -v wkhtmltopdf &> /dev/null; then
            echo "‚úÖ wkhtmltopdf: $(which wkhtmltopdf)"
          else
            echo "‚ö†Ô∏è  wkhtmltopdf NOT FOUND"
          fi
          
          if command -v python3 &> /dev/null; then
            echo "‚úÖ python3: $(python3 --version)"
          else
            echo "‚ö†Ô∏è  python3 NOT FOUND"
          fi
          
          if command -v xvfb-run &> /dev/null; then
            echo "‚úÖ xvfb-run available (for GUI environments)"
          else
            echo "‚ö†Ô∏è  xvfb-run NOT available"
          fi
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Export PATH for subsequent steps
          echo "PATH=$PATH" >> $GITHUB_ENV
          
      - name: Verify Calcpad Installation
        run: |
          echo "üîç Double-checking calcpad installation..."
          
          # Check if it's ACTUALLY installed
          FOUND=0
          
          # Try direct command
          if command -v calcpad-run &> /dev/null; then
            echo "‚úÖ calcpad-run found in PATH"
            which calcpad-run
            FOUND=1
          fi
          
          # Try common locations
          for loc in /usr/bin/calcpad-run /usr/local/bin/calcpad-run /snap/bin/calcpad-run ~/.local/bin/calcpad-run /opt/calcpad/calcpad-run; do
            if [ -x "$loc" ]; then
              echo "‚úÖ calcpad-run found at: $loc"
              "$loc" --version 2>/dev/null || echo "   (binary exists)"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 0 ]; then
            echo "‚ö†Ô∏è  CRITICAL: calcpad-run still NOT found!"
            echo ""
            echo "Attempting alternative: Installing via Calcpad website direct download..."
            
            # Try downloading latest calcpad binary directly
            mkdir -p /tmp/calcpad-install
            cd /tmp/calcpad-install
            
            # Try different download sources
            echo "Trying calcpad.eu..."
            wget -q -O calcpad.tar.gz https://calcpad.eu/downloads/calcpad-ubuntu-latest.tar.gz 2>/dev/null && \
              tar -xzf calcpad.tar.gz -C /opt/ 2>/dev/null && \
              echo "‚úÖ Downloaded and extracted from calcpad.eu" || \
              echo "‚ö†Ô∏è  calcpad.eu download failed"
            
            # Check again
            if [ -x "/opt/calcpad/calcpad-run" ] || [ -x "/usr/bin/calcpad-run" ]; then
              echo "‚úÖ Calcpad now available!"
            else
              echo "‚ùå Calcpad still unavailable - workflow will fail"
            fi
            
            cd - > /dev/null
          fi

      - name: Process CPD Files with Sync
        run: |
          set -x  # Enable debug output
          mkdir -p cpdoutput cpdpdf
          
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üîç GITHUB ACTIONS CPD-HTML-PDF SYNCHRONIZATION"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          # Pre-flight checks
          echo ""
          echo "üìÇ PRE-FLIGHT CHECKS:"
          echo "   Working directory: $(pwd)"
          echo "   cpdinput/ contents:"
          ls -lah cpdinput/ || echo "   (cpdinput/ does not exist!)"
          echo ""
          echo "   cpdoutput/ status:"
          ls -lah cpdoutput/ 2>/dev/null || echo "   (will be created)"
          echo ""
          echo "   cpdpdf/ status:"
          ls -lah cpdpdf/ 2>/dev/null || echo "   (will be created)"
          echo ""
          
          # =========================================================
          # STEP 1: DETECT AND DELETE ORPHANED FILES
          # =========================================================
          echo ""
          echo "üìã STEP 1: Detecting deleted .cpd files..."
          echo "‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï"
          
          DELETED_FILES=$(git show --name-status HEAD 2>/dev/null | grep "^D" | grep "\.cpd$" | awk '{print $2}' || echo "")
          
          if [ -z "$DELETED_FILES" ]; then
            echo "‚úÖ No deleted .cpd files"
          else
            echo "üóëÔ∏è  Found deleted files:"
            echo "$DELETED_FILES"
            
            # For each deleted .cpd, remove corresponding HTML and PDF
            while IFS= read -r deleted_path; do
              if [ -n "$deleted_path" ]; then
                filename=$(basename "$deleted_path" .cpd)
                html_file="cpdoutput/${filename}.html"
                pdf_file="cpdpdf/${filename}.pdf"
                
                if [ -f "$html_file" ]; then
                  rm -f "$html_file"
                  echo "  ‚úÖ Removed: $html_file"
                fi
                
                if [ -f "$pdf_file" ]; then
                  rm -f "$pdf_file"
                  echo "  ‚úÖ Removed: $pdf_file"
                fi
              fi
            done <<< "$DELETED_FILES"
          fi
          
          # =========================================================
          # STEP 2: PROCESS NEW AND MODIFIED CPD FILES
          # =========================================================
          echo ""
          echo "üìã STEP 2: Detecting new/modified .cpd files..."
          echo "‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï"
          
          CHANGED_FILES=$(git show --name-status HEAD 2>/dev/null | grep -E "^[AM]" | grep "\.cpd$" | awk '{print $2}' || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "‚úÖ No new/modified .cpd files"
          else
            echo "üÜï Found changed files:"
            echo "$CHANGED_FILES"
            
            # Process each changed .cpd file
            while IFS= read -r cpd_path; do
              if [ -n "$cpd_path" ] && [ -f "$cpd_path" ]; then
                filename=$(basename "$cpd_path" .cpd)
                echo ""
                echo "  üîÑ Processing: $filename"
                
                # Generate HTML via Calcpad
                if command -v calcpad-run &> /dev/null; then
                  CALCPAD_CMD="calcpad-run"
                elif command -v /snap/bin/calcpad-run &> /dev/null; then
                  CALCPAD_CMD="/snap/bin/calcpad-run"
                else
                  CALCPAD_CMD=""
                fi
                
                if [ -n "$CALCPAD_CMD" ]; then
                  echo "    ‚îú‚îÄ Generating HTML ($CALCPAD_CMD)..."
                  echo "       File: $cpd_path"
                  
                  # Run with XVFB if needed (for GUI environment)
                  if xvfb-run -a "$CALCPAD_CMD" "$cpd_path" 2>&1; then
                    echo "    ‚îú‚îÄ ‚úÖ calcpad-run execution successful"
                  elif "$CALCPAD_CMD" "$cpd_path" 2>&1; then
                    echo "    ‚îú‚îÄ ‚úÖ calcpad-run execution successful"
                  else
                    EXIT_CODE=$?
                    echo "    ‚îú‚îÄ ‚ùå calcpad-run failed (exit code: $EXIT_CODE)"
                  fi
                else
                  echo "    ‚îú‚îÄ ‚ùå calcpad-run COMMAND NOT FOUND"
                  echo "       Attempting alternate search..."
                  RUNCPD=$(find /usr /snap -name "calcpad-run" 2>/dev/null | head -1)
                  if [ -n "$RUNCPD" ]; then
                    echo "       Found at: $RUNCPD"
                    if xvfb-run -a "$RUNCPD" "$cpd_path" 2>&1; then
                      echo "       ‚úÖ Execution successful"
                    elif "$RUNCPD" "$cpd_path" 2>&1; then
                      echo "       ‚úÖ Execution successful"
                    else
                      echo "       ‚ùå Execution failed"
                    fi
                  else
                    echo "       (No calcpad-run binary found anywhere!)"
                  fi
                fi
                
                # Check if HTML was actually created
                echo "    ‚îú‚îÄ Checking for generated HTML..."
                if [ -f "cpdinput/$filename.html" ]; then
                  FILE_SIZE=$(du -h cpdinput/$filename.html | cut -f1)
                  echo "    ‚îú‚îÄ ‚úÖ Found: cpdinput/$filename.html ($FILE_SIZE)"
                else
                  echo "    ‚îú‚îÄ ‚ùå NOT FOUND: cpdinput/$filename.html"
                  echo "       Contents of cpdinput/ directory:"
                  ls -lah cpdinput/ 2>/dev/null | grep -E "\.html|$filename" || echo "       (No matches found)"
                fi
                
                # Move HTML to output folder
                if [ -f "cpdinput/$filename.html" ]; then
                  mv "cpdinput/$filename.html" "cpdoutput/$filename.html"
                  echo "    ‚îú‚îÄ ‚úÖ HTML moved: cpdoutput/$filename.html"
                  
                  # Convert to PDF
                  if command -v wkhtmltopdf &> /dev/null; then
                    echo "    ‚îú‚îÄ Converting to PDF (wkhtmltopdf)..."
                    if wkhtmltopdf --quiet "cpdoutput/$filename.html" "cpdpdf/$filename.pdf" 2>/dev/null; then
                      echo "    ‚îî‚îÄ ‚úÖ PDF created: cpdpdf/$filename.pdf"
                    else
                      echo "    ‚îî‚îÄ ‚ö†Ô∏è  PDF conversion failed (continuing anyway)"
                    fi
                  else
                    echo "    ‚îî‚îÄ ‚ö†Ô∏è  wkhtmltopdf not available - HTML only"
                  fi
                else
                  echo "    ‚îî‚îÄ ‚ùå ERROR: HTML not generated for $filename"
                fi
              fi
            done <<< "$CHANGED_FILES"
          fi
          
          # =========================================================
          # STEP 3: REPORT FINAL STATE
          # =========================================================
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üìä FINAL STATE REPORT"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          echo ""
          echo "üìÇ Current CPD files in cpdinput/:"
          ls -1 cpdinput/*.cpd 2>/dev/null | wc -l
          ls -1 cpdinput/*.cpd 2>/dev/null || echo "  (none)"
          
          echo ""
          echo "üìÑ Generated HTML files in cpdoutput/:"
          HTML_COUNT=$(ls -1 cpdoutput/*.html 2>/dev/null | wc -l)
          echo "  Total: $HTML_COUNT files"
          ls -lh cpdoutput/*.html 2>/dev/null || echo "  (none)"
          
          echo ""
          echo "üìï Generated PDF files in cpdpdf/:"
          PDF_COUNT=$(ls -1 cpdpdf/*.pdf 2>/dev/null | wc -l)
          echo "  Total: $PDF_COUNT files"
          ls -lh cpdpdf/*.pdf 2>/dev/null || echo "  (none)"
          
          echo ""
          echo "‚ú® Synchronization complete!"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

      - name: Update Navigation Index
        run: |
          echo "üîÑ Updating index..."
          python3 scripts/update_index.py
          echo "‚úÖ Index updated"
          
          # Show what was generated
          echo ""
          echo "=== FINAL STATE ==="
          echo "HTML files in cpdoutput:"
          ls -1 cpdoutput/*.html 2>/dev/null | wc -l
          echo ""
          echo "calcpad.html content preview:"
          grep "report-count" calcpad.html || echo "No report-count found"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes to commit
          if git diff --quiet cpdoutput/ cpdpdf/ calcpad.html; then
            echo "‚úÖ No changes to commit (files already processed)"
          else
            echo "üìù Committing generated reports (HTML + PDF)..."
            git add cpdoutput/*.html cpdpdf/*.pdf calcpad.html 2>/dev/null || true
            git commit -m "Auto-generate reports: HTML + PDF [skip ci]"
            
            # Use GITHUB_TOKEN for authentication
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/hydrostructai/calcpad_engineering.git
            git push origin main
            echo "‚úÖ Pushed to GitHub"
          fi