name: Calcpad Automation Workflow

on:
  push:
    paths:
      - 'cpdinput/**.cpd'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Verify Calcpad Installation
        run: |
          calcpad-run --help || echo "‚ö†Ô∏è calcpad-run not available, will be handled by GitHub"
          echo "Using calcpad-run from system PATH"

      - name: Process CPD Files
        run: |
          mkdir -p cpdoutput
          cd /home/runner/work/calcpad_engineering/calcpad_engineering
          
          find cpdinput -maxdepth 1 -name "*.cpd" -type f | while IFS= read -r file; do
            [ -e "$file" ] || continue
            filename=$(basename "$file" .cpd)
            echo "üîÑ Processing: $filename"
            
            # Use calcpad-run wrapper script with proper quoting
            bash /usr/local/bin/calcpad-run "$file" 2>&1 || {
              echo "‚ö†Ô∏è Warning: Failed to process $filename"
              continue
            }
            
            if [ -f "cpdinput/$filename.html" ]; then
              mv "cpdinput/$filename.html" "cpdoutput/$filename.html"
              echo "‚úÖ Generated: cpdoutput/$filename.html"
            else
              echo "‚ùå HTML not generated for $filename"
            fi
          done

      - name: Update Navigation Index
        run: |
          python3 scripts/update_index.py

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add cpdoutput/*.html calcpad.html
          git commit -m "Auto-generate reports [skip ci]" || echo "No changes to commit"
          
          # Use GITHUB_TOKEN for authentication
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/hydrostructai/calcpad_engineering.git
          git push origin main || echo "Push failed - may already be synced"