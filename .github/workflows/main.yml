name: Calcpad Automation Workflow (Docker Edition)

on:
  push:
    paths:
      - 'cpdinput/**.cpd'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          echo "üîß Installing base dependencies..."
          sudo apt-get update -qq
          sudo apt-get install -y \
            git python3 python3-pip \
            wkhtmltopdf wget curl \
            xvfb libxrender1 libxext6 \
            docker.io
          echo "‚úÖ Base dependencies installed"

      - name: Setup Calcpad (Docker Priority)
        run: |
          echo "üê≥ Setting up Calcpad with Docker..."
          
          # Try 1: Docker image
          echo "üì¶ Attempting Docker image..."
          if docker pull agentim/calcpad:latest 2>&1 | grep -q "Pulling\|Downloaded\|Digest"; then
            echo "‚úÖ Docker image available!"
            echo "CALCPAD_USE_DOCKER=true" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è  Docker image not available, trying native installation..."
            
            # Try 2: Install from system packages
            echo "üì¶ Attempting native installation..."
            
            # Add PPA
            if sudo add-apt-repository -y ppa:agentim/calcpad 2>/dev/null && \
               sudo apt-get update -qq 2>/dev/null && \
               sudo apt-get install -y calcpad 2>/dev/null; then
              echo "‚úÖ Calcpad installed from PPA"
              echo "CALCPAD_INSTALLED=true" >> $GITHUB_ENV
            else
              echo "‚ö†Ô∏è  PPA installation failed"
              
              # Try 3: Snap
              if sudo snap install calcpad --classic 2>/dev/null; then
                echo "‚úÖ Calcpad installed from snap"
                export PATH=/snap/bin:$PATH
                echo "PATH=$PATH" >> $GITHUB_ENV
                echo "CALCPAD_INSTALLED=true" >> $GITHUB_ENV
              else
                echo "‚ö†Ô∏è  Snap installation failed"
                
                # Try 4: Build from source
                echo "üì¶ Building from source..."
                mkdir -p /tmp/calcpad-build
                cd /tmp/calcpad-build
                
                if git clone --depth 1 https://github.com/Proectors/Calcpad.git 2>/dev/null; then
                  cd Calcpad
                  
                  # Try with dotnet
                  if command -v dotnet &> /dev/null; then
                    if dotnet build -c Release 2>&1 | grep -q "Build succeeded"; then
                      echo "‚úÖ Built from source successfully"
                      echo "CALCPAD_BUILT_FROM_SOURCE=true" >> $GITHUB_ENV
                    fi
                  fi
                fi
              fi
            fi
          fi
          
          echo ""
          echo "üîç Calcpad Status:"
          if [ "$CALCPAD_USE_DOCKER" = "true" ]; then
            echo "‚úÖ Using Docker"
          elif [ "$CALCPAD_INSTALLED" = "true" ]; then
            echo "‚úÖ Native installation available"
            command -v calcpad-run && echo "   Found at: $(which calcpad-run)"
          elif [ "$CALCPAD_BUILT_FROM_SOURCE" = "true" ]; then
            echo "‚úÖ Built from source"
          else
            echo "‚ö†Ô∏è  No Calcpad method available - will attempt inline processing"
          fi

      - name: Process CPD Files
        run: |
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üîÑ CALCPAD FILE SYNCHRONIZATION"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          mkdir -p cpdoutput cpdpdf
          
          # Get list of changed CPD files
          echo ""
          echo "üìã Detecting changed .cpd files..."
          CHANGED_FILES=$(git show --name-status HEAD 2>/dev/null | grep -E "^[AM]" | grep "\.cpd$" | awk '{print $2}' | sort | uniq)
          DELETED_FILES=$(git show --name-status HEAD 2>/dev/null | grep "^D" | grep "\.cpd$" | awk '{print $2}' | sort | uniq)
          
          # Handle deleted files
          if [ -n "$DELETED_FILES" ]; then
            echo ""
            echo "üóëÔ∏è  Removing orphaned HTML/PDF files..."
            while IFS= read -r deleted_path; do
              if [ -n "$deleted_path" ]; then
                filename=$(basename "$deleted_path" .cpd)
                rm -f "cpdoutput/${filename}.html" "cpdpdf/${filename}.pdf"
                [ -f "cpdoutput/${filename}.html" ] || echo "  ‚úÖ Removed: cpdoutput/${filename}.html"
                [ -f "cpdpdf/${filename}.pdf" ] || echo "  ‚úÖ Removed: cpdpdf/${filename}.pdf"
              fi
            done <<< "$DELETED_FILES"
          fi
          
          # Process new/modified files
          if [ -z "$CHANGED_FILES" ]; then
            echo "‚úÖ No new/modified .cpd files"
          else
            echo ""
            echo "üÜï Found changed files:"
            echo "$CHANGED_FILES" | nl
            
            # Process each file
            while IFS= read -r cpd_file; do
              if [ -z "$cpd_file" ] || [ ! -f "$cpd_file" ]; then
                continue
              fi
              
              filename=$(basename "$cpd_file" .cpd)
              echo ""
              echo "üìÑ Processing: $filename.cpd"
              
              # ================================================
              # METHOD 1: Use Docker if available
              # ================================================
              if [ "$CALCPAD_USE_DOCKER" = "true" ]; then
                echo "  üê≥ Using Docker..."
                if docker run --rm \
                  -v "$(pwd):/work" \
                  -w /work \
                  agentim/calcpad:latest \
                  calcpad-run "$cpd_file" 2>&1 | tail -5; then
                  
                  if [ -f "${filename}.html" ]; then
                    mv "${filename}.html" "cpdoutput/${filename}.html"
                    echo "  ‚úÖ HTML generated"
                  fi
                else
                  echo "  ‚ùå Docker processing failed"
                fi
              
              # ================================================
              # METHOD 2: Use native calcpad-run
              # ================================================
              else
                if command -v calcpad-run &> /dev/null; then
                  CALCPAD_CMD=$(which calcpad-run)
                  echo "  ‚úÖ Using native: $CALCPAD_CMD"
                elif command -v /snap/bin/calcpad-run &> /dev/null; then
                  CALCPAD_CMD="/snap/bin/calcpad-run"
                  echo "  ‚úÖ Using snap: $CALCPAD_CMD"
                else
                  CALCPAD_CMD=""
                  echo "  ‚ùå calcpad-run not found"
                fi
                
                if [ -n "$CALCPAD_CMD" ]; then
                  # Try with xvfb first
                  if xvfb-run -a "$CALCPAD_CMD" "$cpd_file" 2>&1 | tail -3; then
                    if [ -f "${filename}.html" ]; then
                      mv "${filename}.html" "cpdoutput/${filename}.html"
                      echo "  ‚úÖ HTML generated (with xvfb)"
                    fi
                  elif "$CALCPAD_CMD" "$cpd_file" 2>&1 | tail -3; then
                    if [ -f "${filename}.html" ]; then
                      mv "${filename}.html" "cpdoutput/${filename}.html"
                      echo "  ‚úÖ HTML generated (direct)"
                    fi
                  else
                    echo "  ‚ùå calcpad-run failed"
                  fi
                fi
              fi
              
              # Convert to PDF
              if [ -f "cpdoutput/${filename}.html" ]; then
                echo "  üìù Converting to PDF..."
                if wkhtmltopdf --quiet "cpdoutput/${filename}.html" "cpdpdf/${filename}.pdf" 2>/dev/null; then
                  echo "  ‚úÖ PDF generated"
                else
                  echo "  ‚ö†Ô∏è  PDF conversion failed"
                fi
              else
                echo "  ‚ùå HTML not generated - skipping PDF"
              fi
              
            done <<< "$CHANGED_FILES"
          fi
          
          # Report final state
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üìä FINAL STATE"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "HTML files:"
          ls -lh cpdoutput/*.html 2>/dev/null | wc -l
          echo ""
          echo "PDF files:"
          ls -lh cpdpdf/*.pdf 2>/dev/null | wc -l
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

      - name: Commit and Push Results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check for changes
          if git diff --quiet cpdoutput/ cpdpdf/ 2>/dev/null; then
            echo "‚úÖ No changes to commit"
          else
            echo "üìù Committing generated reports..."
            git add cpdoutput/*.html cpdpdf/*.pdf 2>/dev/null || true
            
            if git diff --cached --quiet; then
              echo "‚úÖ No files to commit"
            else
              git commit -m "ü§ñ Auto-generate reports: HTML + PDF [skip ci]" || true
              git push origin main || echo "‚ö†Ô∏è  Push failed (may be normal if no changes)"
            fi
          fi
