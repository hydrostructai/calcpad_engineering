name: Calcpad Automation Workflow (Docker Edition)

on:
  push:
    paths:
      - 'cpdinput/**.cpd'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      # Optional: set this to a valid Docker image that has calcpad-run installed
      # Example (once you have your own image): ghcr.io/hydrostructai/calcpad:latest
      CALCPAD_DOCKER_IMAGE: ""
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install Dependencies
        continue-on-error: true
        run: |
          echo "üîß Installing base dependencies..."
          sudo apt-get update -qq || true
          
          # Install packages one by one to identify failures
          for pkg in git python3 python3-pip xvfb libxrender1 libxext6 docker.io; do
            echo "  Installing $pkg..."
            sudo apt-get install -y "$pkg" 2>/dev/null && echo "  ‚úÖ $pkg" || echo "  ‚ö†Ô∏è  $pkg failed (continuing...)"
          done
          
          # wkhtmltopdf might fail, so handle separately
          echo "  Installing wkhtmltopdf..."
          if sudo apt-get install -y wkhtmltopdf 2>/dev/null; then
            echo "  ‚úÖ wkhtmltopdf"
          else
            echo "  ‚ö†Ô∏è  wkhtmltopdf (will try direct download later)"
            
            # Try direct download
            TEMP_DIR=$(mktemp -d)
            cd "$TEMP_DIR"
            if wget -q https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltox_0.12.6-1.focal_amd64.deb 2>/dev/null; then
              sudo apt-get install -y -f ./wkhtmltox_0.12.6-1.focal_amd64.deb 2>/dev/null && echo "  ‚úÖ wkhtmltopdf (from direct download)" || echo "  ‚ö†Ô∏è  wkhtmltopdf installation failed"
            fi
            cd - > /dev/null
            rm -rf "$TEMP_DIR"
          fi
          
          echo "‚úÖ Dependencies installation completed (some may have failed, but continuing...)"

      - name: Setup Calcpad (Docker Priority)
        continue-on-error: true
        run: |
          echo "üê≥ Setting up Calcpad with Docker..."
          
          # Try 1: Docker image (PRIMARY METHOD)
          echo "üì¶ Attempting Docker image..."
          if [ -n "${CALCPAD_DOCKER_IMAGE}" ]; then
            if command -v docker &> /dev/null; then
              echo "   Using image: ${CALCPAD_DOCKER_IMAGE}"
              if docker pull "${CALCPAD_DOCKER_IMAGE}" >/dev/null 2>&1; then
                echo "‚úÖ Docker image available!"
                # Mark Docker as the primary execution mode
                CALCPAD_USE_DOCKER=true
                echo "CALCPAD_USE_DOCKER=true" >> $GITHUB_ENV
              else
                echo "‚ö†Ô∏è  Docker pull failed for ${CALCPAD_DOCKER_IMAGE} (skipping Docker mode)"
              fi
            else
              echo "‚ö†Ô∏è  Docker command not found on runner (skipping Docker mode)"
            fi
          else
            echo "‚ÑπÔ∏è  CALCPAD_DOCKER_IMAGE not set ‚Äì skipping Docker and using native install only."
          fi
          
          # Try 2: Native installation (FALLBACK)
          # Only attempt native install if Docker is NOT available
          if [ "${CALCPAD_USE_DOCKER:-}" != "true" ]; then
            echo ""
            echo "üì¶ Attempting native installation..."
            
            # Try PPA
            if sudo add-apt-repository -y ppa:agentim/calcpad 2>/dev/null && \
               sudo apt-get update -qq 2>/dev/null && \
               sudo apt-get install -y calcpad 2>/dev/null; then
              echo "‚úÖ Calcpad installed from PPA"
              echo "CALCPAD_INSTALLED=true" >> $GITHUB_ENV
            else
              echo "‚ö†Ô∏è  PPA failed, trying snap..."
              
              # Try snap
              if sudo snap install calcpad --classic 2>/dev/null; then
                echo "‚úÖ Calcpad installed from snap"
                export PATH=/snap/bin:$PATH
                echo "PATH=$PATH" >> $GITHUB_ENV
                echo "CALCPAD_INSTALLED=true" >> $GITHUB_ENV
              else
                echo "‚ö†Ô∏è  Both PPA and snap failed"
              fi
            fi
          fi

          # Try 3: Build from source if still unavailable (use official repo Proektsoftbg/Calcpad)
          if [ "${CALCPAD_USE_DOCKER:-}" != "true" ] && [ "${CALCPAD_INSTALLED:-}" != "true" ]; then
            echo ""
            echo "üîß Building Calcpad from source (fallback)..."
            SRC_DIR=/tmp/calcpad-src
            rm -rf "$SRC_DIR"
            if git clone --depth 1 https://github.com/Proektsoftbg/Calcpad.git "$SRC_DIR" >/tmp/calcpad-clone.log 2>&1; then
              echo "   ‚úÖ Source cloned"
              if dotnet publish "$SRC_DIR/Calcpad.Cli/Calcpad.Cli.csproj" -c Release -r linux-x64 -p:PublishSingleFile=true -p:PublishTrimmed=false --self-contained true >/tmp/calcpad-build.log 2>&1; then
                PUBLISH_DIR=$(ls -d $SRC_DIR/Calcpad.Cli/bin/Release/*/linux-x64/publish 2>/dev/null | head -1)
                if [ -n "$PUBLISH_DIR" ] && [ -f "$PUBLISH_DIR/Calcpad.Cli" ]; then
                  sudo cp "$PUBLISH_DIR/Calcpad.Cli" /usr/local/bin/calcpad-run
                  sudo chmod +x /usr/local/bin/calcpad-run
                  echo "‚úÖ Built calcpad-run from source"
                  echo "CALCPAD_INSTALLED=true" >> $GITHUB_ENV
                else
                  echo "‚ö†Ô∏è  Build succeeded but binary not found (see /tmp/calcpad-build.log)"
                  ls -la "$PUBLISH_DIR" 2>/dev/null || true
                fi
              else
                echo "‚ö†Ô∏è  Build failed (see /tmp/calcpad-build.log)"
              fi
            else
              echo "‚ö†Ô∏è  Could not clone Calcpad source (see /tmp/calcpad-clone.log)"
            fi
          fi
          
          echo ""
          echo "üîç Calcpad Status:"
          if [ "${CALCPAD_USE_DOCKER:-}" = "true" ]; then
            echo "‚úÖ Docker mode enabled"
          elif [ "${CALCPAD_INSTALLED:-}" = "true" ]; then
            echo "‚úÖ Native installation available"
          else
            echo "‚ö†Ô∏è  Calcpad not available (no Docker image, no native install)"
          fi

      - name: Process CPD Files
        run: |
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üîÑ CALCPAD FILE SYNCHRONIZATION"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          mkdir -p cpdoutput cpdpdf
          
          # Get list of changed CPD files
          echo ""
          echo "üìã Detecting changed .cpd files..."
          CHANGED_FILES=$(git show --name-status HEAD 2>/dev/null | grep -E "^[AM]" | grep "\.cpd$" | awk '{print $2}' | sort | uniq)
          DELETED_FILES=$(git show --name-status HEAD 2>/dev/null | grep "^D" | grep "\.cpd$" | awk '{print $2}' | sort | uniq)

          # Detect CPD files missing outputs (HTML/PDF) to reprocess even if not changed
          echo ""
          echo "üìã Detecting CPD files missing HTML/PDF..."
          MISSING_OUTPUTS=""
          while IFS= read -r cpd_file; do
            [ -z "$cpd_file" ] && continue
            filename=$(basename "$cpd_file" .cpd)
            HTML_PATH="cpdoutput/${filename}.html"
            PDF_PATH="cpdpdf/${filename}.pdf"
            if [ ! -f "$HTML_PATH" ] || [ ! -f "$PDF_PATH" ]; then
              MISSING_OUTPUTS="$MISSING_OUTPUTS\n$cpd_file"
            fi
          done < <(find cpdinput -maxdepth 1 -type f -name "*.cpd" | sort)
          
          # Handle deleted files
          if [ -n "$DELETED_FILES" ]; then
            echo ""
            echo "üóëÔ∏è  Removing orphaned HTML/PDF files..."
            while IFS= read -r deleted_path; do
              if [ -n "$deleted_path" ]; then
                filename=$(basename "$deleted_path" .cpd)
                rm -f "cpdoutput/${filename}.html" "cpdpdf/${filename}.pdf"
                [ -f "cpdoutput/${filename}.html" ] || echo "  ‚úÖ Removed: cpdoutput/${filename}.html"
                [ -f "cpdpdf/${filename}.pdf" ] || echo "  ‚úÖ Removed: cpdpdf/${filename}.pdf"
              fi
            done <<< "$DELETED_FILES"
          fi
          
          # Build unified processing list: changed files + missing outputs
          PROCESS_FILES=$(printf "%b" "$CHANGED_FILES\n$MISSING_OUTPUTS" | sed '/^$/d' | sort -u)

          # Process files if any
          if [ -z "$PROCESS_FILES" ]; then
            echo "‚úÖ No work: no changed .cpd and all outputs already exist"
          else
            echo ""
            echo "üÜï Files to process (changed or missing outputs):"
            echo "$PROCESS_FILES" | nl
            
            # Process each file
            while IFS= read -r cpd_file; do
              if [ -z "$cpd_file" ] || [ ! -f "$cpd_file" ]; then
                continue
              fi
              
              filename=$(basename "$cpd_file" .cpd)
              echo ""
              echo "üìÑ Processing: $filename.cpd"
              
              # ================================================
              # METHOD 1: Use Docker if available
              # ================================================
              if [ "${CALCPAD_USE_DOCKER:-}" = "true" ]; then
                echo "  üê≥ Using Docker..."
                if docker run --rm \
                  -v "$(pwd):/work" \
                  -w /work \
                  "${CALCPAD_DOCKER_IMAGE}" \
                  calcpad-run "$cpd_file" 2>&1 | tail -5; then
                  
                  if [ -f "${filename}.html" ]; then
                    mv "${filename}.html" "cpdoutput/${filename}.html"
                    echo "  ‚úÖ HTML generated"
                  fi
                else
                  echo "  ‚ùå Docker processing failed (image: ${CALCPAD_DOCKER_IMAGE})."
                fi
              
              # ================================================
              # METHOD 2: Use native calcpad-run
              # ================================================
              else
                if command -v calcpad-run &> /dev/null; then
                  CALCPAD_CMD=$(which calcpad-run)
                  echo "  ‚úÖ Using native: $CALCPAD_CMD"
                elif command -v /snap/bin/calcpad-run &> /dev/null; then
                  CALCPAD_CMD="/snap/bin/calcpad-run"
                  echo "  ‚úÖ Using snap: $CALCPAD_CMD"
                else
                  CALCPAD_CMD=""
                  echo "  ‚ö†Ô∏è  calcpad-run not available on this runner (no native install). Skipping HTML generation for this file."
                  # Skip to next file instead of trying to run a non-existent binary
                  continue
                fi
                
                if [ -n "$CALCPAD_CMD" ]; then
                  # Try with xvfb first
                  if xvfb-run -a "$CALCPAD_CMD" "$cpd_file" 2>&1 | tail -3; then
                    if [ -f "${filename}.html" ]; then
                      mv "${filename}.html" "cpdoutput/${filename}.html"
                      echo "  ‚úÖ HTML generated (with xvfb)"
                    fi
                  elif "$CALCPAD_CMD" "$cpd_file" 2>&1 | tail -3; then
                    if [ -f "${filename}.html" ]; then
                      mv "${filename}.html" "cpdoutput/${filename}.html"
                      echo "  ‚úÖ HTML generated (direct)"
                    fi
                  else
                    echo "  ‚ùå calcpad-run failed"
                  fi
                fi
              fi
              
              # Convert to PDF
              if [ -f "cpdoutput/${filename}.html" ]; then
                echo "  üìù Converting to PDF..."
                if wkhtmltopdf --quiet "cpdoutput/${filename}.html" "cpdpdf/${filename}.pdf" 2>/dev/null; then
                  echo "  ‚úÖ PDF generated"
                else
                  echo "  ‚ö†Ô∏è  PDF conversion failed"
                fi
              else
                echo "  ‚ùå HTML not generated - skipping PDF"
              fi
              
            done <<< "$PROCESS_FILES"
          fi
          
          # Report final state
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üìä FINAL STATE"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "HTML files:"
          ls -lh cpdoutput/*.html 2>/dev/null | wc -l
          echo ""
          echo "PDF files:"
          ls -lh cpdpdf/*.pdf 2>/dev/null | wc -l
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

      - name: Commit and Push Results
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check for changes
          if git diff --quiet cpdoutput/ cpdpdf/ 2>/dev/null; then
            echo "‚úÖ No changes to commit"
          else
            echo "üìù Committing generated reports..."
            git add cpdoutput/*.html cpdpdf/*.pdf 2>/dev/null || true
            
            if git diff --cached --quiet; then
              echo "‚úÖ No files to commit"
            else
              git commit -m "ü§ñ Auto-generate reports: HTML + PDF [skip ci]" || true
              git push origin main || echo "‚ö†Ô∏è  Push failed (may be normal if no changes)"
            fi
          fi
