name: Calcpad Automation Workflow

on:
  push:
    paths:
      - 'cpdinput/**.cpd'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Calcpad and Dependencies
        run: |
          echo "üîß Installing dependencies for Calcpad..."
          
          # Update package lists
          sudo apt-get update -qq 2>/dev/null
          
          # Install essential build tools and libraries first
          echo "üì¶ Installing system dependencies..."
          sudo apt-get install -y \
            build-essential \
            wget \
            curl \
            unzip \
            git \
            python3 \
            python3-pip \
            xvfb \
            libxrender1 \
            libxext6 \
            libglib2.0-0 \
            libgtk-3-0 \
            2>/dev/null || echo "‚ö†Ô∏è  Some dependencies failed"
          
          echo "‚úÖ System dependencies installed"
          
          # Method 1: Try snap (most reliable for calcpad)
          echo "üì¶ Method 1: Attempting snap installation..."
          if sudo snap install calcpad --classic 2>/dev/null; then
            echo "‚úÖ calcpad installed via snap"
          else
            echo "‚ö†Ô∏è  snap installation failed, trying apt..."
            
            # Method 2: Try APT calcpad package
            echo "üì¶ Method 2: Attempting apt installation..."
            if sudo apt-get install -y calcpad 2>/dev/null; then
              echo "‚úÖ calcpad installed via apt"
            else
              echo "‚ö†Ô∏è  apt calcpad not available"
              
              # Method 3: Try calcpad-cli
              echo "üì¶ Method 3: Attempting calcpad-cli..."
              if sudo apt-get install -y calcpad-cli 2>/dev/null; then
                echo "‚úÖ calcpad-cli installed"
              else
                echo "‚ö†Ô∏è  calcpad-cli also not available"
              fi
            fi
          fi
          
          # Install wkhtmltopdf with dependencies
          echo "üì¶ Installing wkhtmltopdf..."
          sudo apt-get install -y wkhtmltopdf 2>/dev/null || \
          (wget -q https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6-1/wkhtmltox_0.12.6-1.focal_amd64.deb && \
           sudo apt-get install -y ./wkhtmltox_0.12.6-1.focal_amd64.deb 2>/dev/null && \
           rm -f wkhtmltox_0.12.6-1.focal_amd64.deb) || \
          echo "‚ö†Ô∏è  wkhtmltopdf installation skipped"
          
          # Verify installations
          echo ""
          echo "üîç VERIFICATION:"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          if command -v calcpad-run &> /dev/null; then
            echo "‚úÖ calcpad-run found at: $(which calcpad-run)"
            calcpad-run --version 2>/dev/null || echo "   (version: unknown)"
          elif command -v calcpad &> /dev/null; then
            echo "‚úÖ calcpad found at: $(which calcpad)"
          elif snap list calcpad 2>/dev/null; then
            echo "‚úÖ calcpad snap installed"
            /snap/bin/calcpad-run --version 2>/dev/null || echo "   (snap version: unknown)"
          else
            echo "‚ö†Ô∏è  WARNING: calcpad NOT FOUND"
            echo "   Searching for calcpad binaries..."
            find /usr -name "*calcpad*" 2>/dev/null | head -5 || echo "   (none found)"
          fi
          
          if command -v wkhtmltopdf &> /dev/null; then
            echo "‚úÖ wkhtmltopdf found at: $(which wkhtmltopdf)"
          else
            echo "‚ö†Ô∏è  wkhtmltopdf NOT FOUND"
          fi
          
          if command -v python3 &> /dev/null; then
            echo "‚úÖ python3: $(python3 --version)"
          else
            echo "‚ö†Ô∏è  python3 NOT FOUND"
          fi
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

      - name: Process CPD Files with Sync
        run: |
          set -x  # Enable debug output
          mkdir -p cpdoutput cpdpdf
          
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üîç GITHUB ACTIONS CPD-HTML-PDF SYNCHRONIZATION"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          # Pre-flight checks
          echo ""
          echo "üìÇ PRE-FLIGHT CHECKS:"
          echo "   Working directory: $(pwd)"
          echo "   cpdinput/ contents:"
          ls -lah cpdinput/ || echo "   (cpdinput/ does not exist!)"
          echo ""
          echo "   cpdoutput/ status:"
          ls -lah cpdoutput/ 2>/dev/null || echo "   (will be created)"
          echo ""
          echo "   cpdpdf/ status:"
          ls -lah cpdpdf/ 2>/dev/null || echo "   (will be created)"
          echo ""
          
          # =========================================================
          # STEP 1: DETECT AND DELETE ORPHANED FILES
          # =========================================================
          echo ""
          echo "üìã STEP 1: Detecting deleted .cpd files..."
          echo "‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï"
          
          DELETED_FILES=$(git show --name-status HEAD 2>/dev/null | grep "^D" | grep "\.cpd$" | awk '{print $2}' || echo "")
          
          if [ -z "$DELETED_FILES" ]; then
            echo "‚úÖ No deleted .cpd files"
          else
            echo "üóëÔ∏è  Found deleted files:"
            echo "$DELETED_FILES"
            
            # For each deleted .cpd, remove corresponding HTML and PDF
            while IFS= read -r deleted_path; do
              if [ -n "$deleted_path" ]; then
                filename=$(basename "$deleted_path" .cpd)
                html_file="cpdoutput/${filename}.html"
                pdf_file="cpdpdf/${filename}.pdf"
                
                if [ -f "$html_file" ]; then
                  rm -f "$html_file"
                  echo "  ‚úÖ Removed: $html_file"
                fi
                
                if [ -f "$pdf_file" ]; then
                  rm -f "$pdf_file"
                  echo "  ‚úÖ Removed: $pdf_file"
                fi
              fi
            done <<< "$DELETED_FILES"
          fi
          
          # =========================================================
          # STEP 2: PROCESS NEW AND MODIFIED CPD FILES
          # =========================================================
          echo ""
          echo "üìã STEP 2: Detecting new/modified .cpd files..."
          echo "‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï‚Äï"
          
          CHANGED_FILES=$(git show --name-status HEAD 2>/dev/null | grep -E "^[AM]" | grep "\.cpd$" | awk '{print $2}' || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "‚úÖ No new/modified .cpd files"
          else
            echo "üÜï Found changed files:"
            echo "$CHANGED_FILES"
            
            # Process each changed .cpd file
            while IFS= read -r cpd_path; do
              if [ -n "$cpd_path" ] && [ -f "$cpd_path" ]; then
                filename=$(basename "$cpd_path" .cpd)
                echo ""
                echo "  üîÑ Processing: $filename"
                
                # Generate HTML via Calcpad
                if command -v calcpad-run &> /dev/null; then
                  CALCPAD_CMD="calcpad-run"
                elif command -v /snap/bin/calcpad-run &> /dev/null; then
                  CALCPAD_CMD="/snap/bin/calcpad-run"
                else
                  CALCPAD_CMD=""
                fi
                
                if [ -n "$CALCPAD_CMD" ]; then
                  echo "    ‚îú‚îÄ Generating HTML ($CALCPAD_CMD)..."
                  echo "       File: $cpd_path"
                  
                  # Run with XVFB if needed (for GUI environment)
                  if xvfb-run -a "$CALCPAD_CMD" "$cpd_path" 2>&1; then
                    echo "    ‚îú‚îÄ ‚úÖ calcpad-run execution successful"
                  elif "$CALCPAD_CMD" "$cpd_path" 2>&1; then
                    echo "    ‚îú‚îÄ ‚úÖ calcpad-run execution successful"
                  else
                    EXIT_CODE=$?
                    echo "    ‚îú‚îÄ ‚ùå calcpad-run failed (exit code: $EXIT_CODE)"
                  fi
                else
                  echo "    ‚îú‚îÄ ‚ùå calcpad-run COMMAND NOT FOUND"
                  echo "       Attempting alternate search..."
                  RUNCPD=$(find /usr /snap -name "calcpad-run" 2>/dev/null | head -1)
                  if [ -n "$RUNCPD" ]; then
                    echo "       Found at: $RUNCPD"
                    if xvfb-run -a "$RUNCPD" "$cpd_path" 2>&1; then
                      echo "       ‚úÖ Execution successful"
                    elif "$RUNCPD" "$cpd_path" 2>&1; then
                      echo "       ‚úÖ Execution successful"
                    else
                      echo "       ‚ùå Execution failed"
                    fi
                  else
                    echo "       (No calcpad-run binary found anywhere!)"
                  fi
                fi
                
                # Check if HTML was actually created
                echo "    ‚îú‚îÄ Checking for generated HTML..."
                if [ -f "cpdinput/$filename.html" ]; then
                  FILE_SIZE=$(du -h cpdinput/$filename.html | cut -f1)
                  echo "    ‚îú‚îÄ ‚úÖ Found: cpdinput/$filename.html ($FILE_SIZE)"
                else
                  echo "    ‚îú‚îÄ ‚ùå NOT FOUND: cpdinput/$filename.html"
                  echo "       Contents of cpdinput/ directory:"
                  ls -lah cpdinput/ 2>/dev/null | grep -E "\.html|$filename" || echo "       (No matches found)"
                fi
                
                # Move HTML to output folder
                if [ -f "cpdinput/$filename.html" ]; then
                  mv "cpdinput/$filename.html" "cpdoutput/$filename.html"
                  echo "    ‚îú‚îÄ ‚úÖ HTML moved: cpdoutput/$filename.html"
                  
                  # Convert to PDF
                  if command -v wkhtmltopdf &> /dev/null; then
                    echo "    ‚îú‚îÄ Converting to PDF (wkhtmltopdf)..."
                    if wkhtmltopdf --quiet "cpdoutput/$filename.html" "cpdpdf/$filename.pdf" 2>/dev/null; then
                      echo "    ‚îî‚îÄ ‚úÖ PDF created: cpdpdf/$filename.pdf"
                    else
                      echo "    ‚îî‚îÄ ‚ö†Ô∏è  PDF conversion failed (continuing anyway)"
                    fi
                  else
                    echo "    ‚îî‚îÄ ‚ö†Ô∏è  wkhtmltopdf not available - HTML only"
                  fi
                else
                  echo "    ‚îî‚îÄ ‚ùå ERROR: HTML not generated for $filename"
                fi
              fi
            done <<< "$CHANGED_FILES"
          fi
          
          # =========================================================
          # STEP 3: REPORT FINAL STATE
          # =========================================================
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "  üìä FINAL STATE REPORT"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          
          echo ""
          echo "üìÇ Current CPD files in cpdinput/:"
          ls -1 cpdinput/*.cpd 2>/dev/null | wc -l
          ls -1 cpdinput/*.cpd 2>/dev/null || echo "  (none)"
          
          echo ""
          echo "üìÑ Generated HTML files in cpdoutput/:"
          HTML_COUNT=$(ls -1 cpdoutput/*.html 2>/dev/null | wc -l)
          echo "  Total: $HTML_COUNT files"
          ls -lh cpdoutput/*.html 2>/dev/null || echo "  (none)"
          
          echo ""
          echo "üìï Generated PDF files in cpdpdf/:"
          PDF_COUNT=$(ls -1 cpdpdf/*.pdf 2>/dev/null | wc -l)
          echo "  Total: $PDF_COUNT files"
          ls -lh cpdpdf/*.pdf 2>/dev/null || echo "  (none)"
          
          echo ""
          echo "‚ú® Synchronization complete!"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

      - name: Update Navigation Index
        run: |
          echo "üîÑ Updating index..."
          python3 scripts/update_index.py
          echo "‚úÖ Index updated"
          
          # Show what was generated
          echo ""
          echo "=== FINAL STATE ==="
          echo "HTML files in cpdoutput:"
          ls -1 cpdoutput/*.html 2>/dev/null | wc -l
          echo ""
          echo "calcpad.html content preview:"
          grep "report-count" calcpad.html || echo "No report-count found"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes to commit
          if git diff --quiet cpdoutput/ cpdpdf/ calcpad.html; then
            echo "‚úÖ No changes to commit (files already processed)"
          else
            echo "üìù Committing generated reports (HTML + PDF)..."
            git add cpdoutput/*.html cpdpdf/*.pdf calcpad.html 2>/dev/null || true
            git commit -m "Auto-generate reports: HTML + PDF [skip ci]"
            
            # Use GITHUB_TOKEN for authentication
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/hydrostructai/calcpad_engineering.git
            git push origin main
            echo "‚úÖ Pushed to GitHub"
          fi