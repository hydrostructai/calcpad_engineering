name: Calcpad Automation Workflow

on:
  push:
    paths:
      - 'cpdinput/**.cpd'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup .NET 8.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Install Calcpad CLI via Dotnet Tool
        run: |
          dotnet tool install --global Calcpad.Cli --version 7.5.9
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Verify Installation
        run: |
          calcpad --version || calcpad -h

      - name: Process CPD Files
        run: |
          mkdir -p cpdoutput
          
          for file in cpdinput/*.cpd; do
            [ -e "$file" ] || continue
            filename=$(basename "$file" .cpd)
            echo "ðŸ”„ Processing: $filename"
            
            calcpad "$file"
            
            if [ -f "cpdinput/$filename.html" ]; then
              mv "cpdinput/$filename.html" "cpdoutput/$filename.html"
              echo "âœ… Generated: cpdoutput/$filename.html"
            fi
          done

      - name: Update Navigation Index
        run: |
          python3 scripts/update_index.py

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add cpdoutput/*.html calcpad.html
          git commit -m "Auto-generate reports [skip ci]" || echo "No changes"
          git push