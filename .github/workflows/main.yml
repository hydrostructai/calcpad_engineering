name: Calcpad Automation Workflow

on:
  push:
    paths:
      - 'cpdinput/**.cpd'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Calcpad and Dependencies
        run: |
          # Try to find calcpad-run in system
          if command -v calcpad-run &> /dev/null; then
            echo "âœ… calcpad-run found in PATH"
            which calcpad-run
          else
            echo "âš ï¸ calcpad-run not found - attempting to locate"
            find / -name "calcpad-run" -o -name "calcpad.exe" 2>/dev/null | head -3
          fi

      - name: Process CPD Files
        run: |
          set -x  # Enable debug output
          mkdir -p cpdoutput cpdpdf
          
          # List all CPD files for debugging
          echo "=== CPD FILES FOUND ==="
          find cpdinput -maxdepth 1 -name "*.cpd" -type f
          echo "========================"
          
          # Process each file
          for file in cpdinput/*.cpd; do
            [ -e "$file" ] || continue
            filename=$(basename "$file" .cpd)
            echo "ðŸ”„ Processing: $filename from $file"
            
            # Try calcpad-run first
            if command -v calcpad-run &> /dev/null; then
              echo "  Using: calcpad-run"
              calcpad-run "$file" || true
            else
              echo "  âš ï¸ calcpad-run not available - trying find"
              RUNCPD=$(find /usr -name "runcpd" 2>/dev/null | head -1)
              if [ -n "$RUNCPD" ]; then
                echo "  Using: $RUNCPD"
                bash "$RUNCPD" "$file" || true
              fi
            fi
            
            # Check if HTML was generated
            if [ -f "cpdinput/$filename.html" ]; then
              mv "cpdinput/$filename.html" "cpdoutput/$filename.html"
              echo "âœ… Generated HTML: cpdoutput/$filename.html"
              
              # Convert HTML to PDF
              if command -v wkhtmltopdf &> /dev/null; then
                echo "  Converting to PDF..."
                wkhtmltopdf --quiet "cpdoutput/$filename.html" "cpdpdf/$filename.pdf" 2>/dev/null || true
                if [ -f "cpdpdf/$filename.pdf" ]; then
                  echo "âœ… Generated PDF: cpdpdf/$filename.pdf"
                else
                  echo "âš ï¸ PDF generation failed for $filename"
                fi
              else
                echo "âš ï¸ wkhtmltopdf not available - skipping PDF"
              fi
            else
              echo "âŒ HTML not generated for $filename"
              # List what files are in cpdinput for debugging
              ls -la cpdinput/ | grep -i "$filename" || echo "No files matching pattern"
            fi
          done
          
          echo "=== FINAL OUTPUT CONTENTS ===" 
          echo "HTML files:"
          ls -lh cpdoutput/ 2>/dev/null || echo "No HTML files"
          echo ""
          echo "PDF files:"
          ls -lh cpdpdf/ 2>/dev/null || echo "No PDF files"

      - name: Update Navigation Index
        run: |
          echo "ðŸ”„ Updating index..."
          python3 scripts/update_index.py
          echo "âœ… Index updated"
          
          # Show what was generated
          echo ""
          echo "=== FINAL STATE ==="
          echo "HTML files in cpdoutput:"
          ls -1 cpdoutput/*.html 2>/dev/null | wc -l
          echo ""
          echo "calcpad.html content preview:"
          grep "report-count" calcpad.html || echo "No report-count found"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes to commit
          if git diff --quiet cpdoutput/ cpdpdf/ calcpad.html; then
            echo "âœ… No changes to commit (files already processed)"
          else
            echo "ðŸ“ Committing generated reports (HTML + PDF)..."
            git add cpdoutput/*.html cpdpdf/*.pdf calcpad.html 2>/dev/null || true
            git commit -m "Auto-generate reports: HTML + PDF [skip ci]"
            
            # Use GITHUB_TOKEN for authentication
            git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/hydrostructai/calcpad_engineering.git
            git push origin main
            echo "âœ… Pushed to GitHub"
          fi