# GitHub Actions Workflow Logic - Complete Explanation

## ğŸ¯ How GitHub Actions Automation Works

When you upload a `.cpd` file to GitHub, the workflow automatically processes it and generates HTML without manual `runcpd` commands.

---

## ğŸ“‹ Trigger Condition

```yaml
on:
  push:
    paths:
      - 'cpdinput/**.cpd'
```

**What this means:**
- âœ… Workflow ONLY triggers when `.cpd` files are pushed to `cpdinput/` folder
- âœ… Must be committed AND pushed to GitHub
- âœ… Changes to other files are ignored

---

## ğŸ”„ Workflow Execution Steps

### Step 1ï¸âƒ£: Checkout Repository
```yaml
- uses: actions/checkout@v4
```
- Clone the repository to GitHub Actions runner
- Working directory: `/home/runner/work/calcpad_engineering/calcpad_engineering`

### Step 2ï¸âƒ£: Install Calcpad and Dependencies
```bash
# Find calcpad-run in system PATH
which calcpad-run
find / -name "calcpad-run" 2>/dev/null
```
- Check if `calcpad-run` is available
- Report location for debugging
- Continue even if not found (fail-safe)

### Step 3ï¸âƒ£: Process CPD Files
**Most Important Step!**

```bash
for file in cpdinput/*.cpd; do
  filename=$(basename "$file" .cpd)
  
  # Try to run calcpad-run
  calcpad-run "$file"
  
  # Check if HTML was created
  if [ -f "cpdinput/$filename.html" ]; then
    mv "cpdinput/$filename.html" "cpdoutput/$filename.html"
  fi
done
```

**What happens:**
1. Find all `.cpd` files in `cpdinput/`
2. Run `calcpad-run file.cpd` to generate HTML
3. HTML is created in `cpdinput/`
4. Move HTML to `cpdoutput/`
5. Show debug output for troubleshooting

### Step 4ï¸âƒ£: Update Navigation Index
```bash
python3 scripts/update_index.py
```
- Extract metadata from generated HTML files
- Automatically update `calcpad.html` with:
  - Report numbers (#1, #2, ...)
  - Report names and titles
  - Calculation methods
  - Results sections
  - Chart indicators
  - File sizes
  - Working links

### Step 5ï¸âƒ£: Commit and Push
```bash
git config --global user.name "github-actions[bot]"
git config --global user.email "github-actions[bot]@users.noreply.github.com"

git add cpdoutput/*.html calcpad.html
git commit -m "Auto-generate reports [skip ci]"
git push origin main
```
- Auto-commit with bot identity
- Use `GITHUB_TOKEN` for authentication (write permission)
- Push back to main branch
- `[skip ci]` prevents infinite loop

---

## ğŸš€ Complete Flow Diagram

```
User Uploads .cpd via GitHub Web
         â†“
GitHub detects push to cpdinput/*.cpd
         â†“
ğŸš€ GitHub Actions Workflow Triggers (Automatically!)
         â†“
Step 1: Checkout code
         â†“
Step 2: Find calcpad-run
         â†“
Step 3: Process CPD Files (calcpad-run)
         â”œâ”€ Run: calcpad-run file.cpd
         â”œâ”€ Output: file.html in cpdinput/
         â””â”€ Move: file.html â†’ cpdoutput/
         â†“
Step 4: Update Index
         â”œâ”€ Extract metadata from HTML
         â””â”€ Regenerate calcpad.html
         â†“
Step 5: Auto-commit & Push
         â”œâ”€ Commit HTML + index
         â””â”€ Push to GitHub
         â†“
âœ… Files Available on GitHub Pages
         â†“
View at: hydrostructai.github.io/calcpad_engineering/calcpad.html
```

---

## âœ… Required Conditions for Automation to Work

### 1. Files Must Be Pushed to GitHub
```bash
# âŒ WRONG - Files exist locally but not on GitHub
git status
  Untracked files:
    cpdinput/file.cpd

# âœ… CORRECT - Files committed and pushed
git push origin main
# Then GitHub Actions triggers
```

### 2. Filename Requirements
- âœ… Must end with `.cpd`
- âœ… Can contain spaces: `Flat Slab FEA.cpd`
- âœ… Cannot contain special characters: `< > : " | ? *`

### 3. Permissions Must Be Set
```yaml
permissions:
  contents: write      # Write to repo
  pull-requests: write # PR operations
```

### 4. GitHub Token Available
```yaml
git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/...
```
- `GITHUB_TOKEN` is automatically provided by GitHub Actions
- Grants write permission to repository

---

## ğŸ” How to Check Workflow Status

### Option 1: GitHub Web Interface
1. Go to: https://github.com/hydrostructai/calcpad_engineering/actions
2. Click on latest workflow run
3. View step-by-step execution with logs
4. See which steps âœ… passed or âŒ failed

### Option 2: Git Commit History
```bash
git log --oneline origin/main -10
```
Look for commits from `github-actions[bot]`:
- `Auto-generate reports [skip ci]` = Workflow ran successfully

### Option 3: Check File Timestamps
```bash
ls -la cpdoutput/
```
Recent files = Recently generated by workflow

---

## âš ï¸ Troubleshooting

### Problem: Workflow Didn't Trigger
**Possible Causes:**
- âŒ File not pushed to GitHub (only local)
- âŒ File path wrong (not in `cpdinput/`)
- âŒ Filename wrong (not `.cpd` extension)
- âŒ Workflow disabled in repository settings

**Solution:**
```bash
# Verify files are on GitHub
git push origin main

# Check remote status
git log --oneline -5
# Should show recent commits
```

### Problem: HTML Not Generated
**Possible Causes:**
- âŒ `calcpad-run` not available on runner
- âŒ CPD file has syntax errors
- âŒ File path has special characters

**Solution:**
1. Check GitHub Actions logs:
   - https://github.com/hydrostructai/calcpad_engineering/actions
   - Look for step "Process CPD Files"
   - Read error messages

2. Test locally:
   ```bash
   bash /home/hha/work/github-guide/Calcpad/Examples_haah/runcpd "cpdinput/file.cpd"
   ```

### Problem: Index Not Updated
**Possible Causes:**
- âŒ No HTML files in `cpdoutput/`
- âŒ Python script error
- âŒ File permissions issue

**Solution:**
```bash
# Run manually
python3 scripts/update_index.py

# Check output
grep "Updated calcpad.html with" scripts/update_index.py output
```

### Problem: Can't Push Changes (403 Error)
**Cause:** Missing write permissions

**Already Fixed By:**
```yaml
permissions:
  contents: write
  pull-requests: write
```

If still failing:
1. Check repository Settings â†’ Actions
2. Verify "Workflow Permissions" = Read and write

---

## ğŸ“Š Expected Behavior Timeline

| Time | Action | Status |
|------|--------|--------|
| T+0s | Push `.cpd` to GitHub | ğŸ“¤ User uploads |
| T+5s | GitHub Actions triggered | ğŸš€ Workflow starts |
| T+30s | Calcpad processes file | âš™ï¸ calcpad-run running |
| T+40s | HTML generated | ğŸ“„ File created |
| T+50s | Index updated | ğŸ”„ calcpad.html updated |
| T+60s | Auto-commit | ğŸ’¾ Files committed |
| T+70s | Auto-push | ğŸ“¤ Pushed to GitHub |
| T+80s | GitHub Pages deploys | ğŸŒ Live on web |
| T+120s | âœ… Complete | âœ¨ Visible on site |

**Total Time: 1-2 minutes**

---

## ğŸ’¡ Best Practices

âœ… **Do:**
- Always push files explicitly to GitHub
- Use clear, descriptive filenames
- Test CPD files locally before uploading
- Check workflow logs if something fails
- Keep `.cpd` files organized in `cpdinput/`

âŒ **Don't:**
- Leave files uncommitted
- Use special characters in filenames
- Upload binary files as `.cpd`
- Modify files while workflow is running
- Disable workflow permissions

---

## ğŸ”— Key URLs

| Purpose | URL |
|---------|-----|
| View Reports | https://hydrostructai.github.io/calcpad_engineering/calcpad.html |
| Workflow Logs | https://github.com/hydrostructai/calcpad_engineering/actions |
| Repository | https://github.com/hydrostructai/calcpad_engineering |
| Upload Files | https://github.com/hydrostructai/calcpad_engineering/tree/main/cpdinput |
| Workflow YAML | https://github.com/hydrostructai/calcpad_engineering/blob/main/.github/workflows/main.yml |

---

## ğŸ“ Summary

**The Workflow AUTOMATICALLY:**
1. âœ… Detects new `.cpd` files pushed to GitHub
2. âœ… Runs `calcpad-run` to generate HTML
3. âœ… Moves HTML to `cpdoutput/` folder
4. âœ… Updates `calcpad.html` with metadata
5. âœ… Commits and pushes results
6. âœ… Deploys to GitHub Pages

**You JUST need to:**
1. Create `.cpd` file
2. Push to GitHub (via web or git)
3. Wait 1-2 minutes
4. View results on GitHub Pages

**No manual `runcpd` needed! No manual HTML creation! ğŸ‰**
